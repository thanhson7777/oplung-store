<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Giỏ hàng | Ốp lưng iPhone Store</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" href="images/favicon.png" />
</head>
<body>
  <header class="header">
    <div class="container header__inner">
      <a class="logo" href="index.html"><span class="logo__mark">ỐP</span><span class="logo__text">iPhone Store</span></a>
      <form class="search" role="search" action="products.html" method="get">
        <label class="sr-only" for="q">Tìm kiếm</label>
        <input id="q" name="q" type="search" placeholder="Tìm ốp lưng, màu sắc..." />
        <button class="btn btn--primary" type="submit">Tìm</button>
      </form>
      <nav class="nav">
        <a href="products.html">Sản phẩm</a>
        <a href="cart.html" class="cart-link" aria-current="page">Giỏ hàng <span id="cart-count" class="badge">0</span></a>
      </nav>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <h1>Giỏ hàng</h1>

      <div id="empty" style="display:none; border:1px solid var(--border); border-radius:16px; padding:16px; background:var(--surface);">
        <p>Giỏ hàng của bạn đang trống.</p>
        <a class="btn btn--primary" href="products.html">Mua sắm ngay</a>
      </div>

      <div id="cart-wrap" style="display:none;">
        <div style="overflow:auto; border:1px solid var(--border); border-radius:16px; background:var(--bg);">
          <table style="width:100%; border-collapse:collapse; min-width:720px;">
            <thead>
              <tr style="background:var(--surface); border-bottom:1px solid var(--border);">
                <th style="text-align:left; padding:12px;">Sản phẩm</th>
                <th style="text-align:right; padding:12px;">Đơn giá</th>
                <th style="text-align:center; padding:12px;">Số lượng</th>
                <th style="text-align:right; padding:12px;">Thành tiền</th>
                <th style="text-align:center; padding:12px;">Xoá</th>
              </tr>
            </thead>
            <tbody id="cart-tbody"></tbody>
          </table>
        </div>

        <div class="section" style="padding-top:16px;">
          <div style="display:grid; gap:16px; grid-template-columns:1fr; max-width:560px; margin-left:auto;">
            <div style="border:1px solid var(--border); border-radius:16px; padding:16px; background:var(--bg);">
              <h2 style="margin:0 0 12px 0;">Tóm tắt đơn hàng</h2>
              <div style="display:grid; gap:8px;">
                <div style="display:flex; justify-content:space-between;">
                  <span>Tạm tính</span><strong id="sum-sub">0₫</strong>
                </div>
                <div style="display:flex; justify-content:space-between;">
                  <span>Phí vận chuyển</span><strong id="sum-ship">0₫</strong>
                </div>
                <hr style="border:none; height:1px; background:var(--border);">
                <div style="display:flex; justify-content:space-between; font-size:18px;">
                  <span>Tổng cộng</span><strong id="sum-total">0₫</strong>
                </div>
              </div>
              <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
                <a class="btn btn--ghost" href="products.html">Tiếp tục mua</a>
                <a id="to-checkout" class="btn btn--primary" href="checkout.html">Thanh toán</a>
              </div>
              <p id="free-ship-tip" style="margin:10px 0 0; color:var(--muted); font-size:14px;"></p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <footer class="footer">
    <div class="container footer__inner">
      <div class="footer__col">
        <h4>Ốp lưng iPhone Store</h4>
        <p>Shop ốp lưng đẹp, bền, nhẹ – hợp mọi phong cách.</p>
      </div>
      <div class="footer__col">
        <h4>Liên kết</h4>
        <ul>
          <li><a href="index.html">Trang chủ</a></li>
          <li><a href="products.html">Sản phẩm</a></li>
          <li><a href="checkout.html">Thanh toán</a></li>
        </ul>
      </div>
      <div class="footer__col">
        <h4>Liên hệ</h4>
        <ul>
          <li>Email: support@oplung.store</li>
          <li>Hotline: 0900 000 000</li>
        </ul>
      </div>
    </div>
    <div class="footer__copy">© <span id="year"></span> Oplung Store.</div>
  </footer>

  <script src="js/main.js" defer></script>
  <script>
    const fmt = n => (n||0).toLocaleString('vi-VN') + '₫';
    const $ = (s, r=document)=>r.querySelector(s);

    const SHIP_THRESHOLD = 300000;
    const SHIP_FEE = 30000;

    (function boot(){
      renderCart();
    })();

    function getCart(){ try { return JSON.parse(localStorage.getItem('cart')||'[]'); } catch { return []; } }
    function setCart(arr){ localStorage.setItem('cart', JSON.stringify(arr)); }

    function renderCart(){
      const cart = getCart();

      document.getElementById('empty').style.display = cart.length? 'none':'block';
      document.getElementById('cart-wrap').style.display = cart.length? 'block':'none';
      if (!cart.length){ Store.updateCartBadge(); return; }

      const tbody = document.getElementById('cart-tbody'); tbody.innerHTML = '';
      cart.forEach((item, idx)=>{
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid var(--border)';
        tr.innerHTML = `
          <td style="padding:12px;">
            <div style="display:flex; align-items:center; gap:12px;">
              <img src="${item.img||'images/oplung-iphone12.png'}" alt="${item.name}" style="width:64px; height:64px; object-fit:cover; border-radius:10px; border:1px solid var(--border);">
              <div>
                <strong>${item.name}</strong>
                <div style="color:var(--muted); font-size:14px;">Mã: ${item.id}</div>
              </div>
            </div>
          </td>
          <td style="padding:12px; text-align:right;">${fmt(item.price)}</td>
          <td style="padding:12px; text-align:center;">
            <div style="display:inline-flex; align-items:center; gap:6px;">
              <button class="btn btn--sm" data-action="dec" data-idx="${idx}" title="Giảm">-</button>
              <input data-idx="${idx}" class="qty-input" type="number" min="1" value="${item.qty||1}" style="width:64px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; text-align:center;">
              <button class="btn btn--sm" data-action="inc" data-idx="${idx}" title="Tăng">+</button>
            </div>
          </td>
          <td style="padding:12px; text-align:right;"><strong>${fmt(item.price*(item.qty||1))}</strong></td>
          <td style="padding:12px; text-align:center;">
            <button class="btn btn--sm btn--ghost" data-action="remove" data-idx="${idx}" title="Xoá">✕</button>
          </td>`;
        tbody.appendChild(tr);
      });

      tbody.onclick = onTableClick;
      tbody.onchange = onQtyChange;

      updateSummary();
      Store.updateCartBadge();
    }

    function onTableClick(e){
      const btn = e.target.closest('button[data-action]'); if (!btn) return;
      const idx = +btn.dataset.idx;
      const action = btn.dataset.action;
      const cart = getCart();

      if (action === 'inc'){ cart[idx].qty = (cart[idx].qty||1)+1; }
      if (action === 'dec'){ cart[idx].qty = Math.max(1,(cart[idx].qty||1)-1); }
      if (action === 'remove'){ cart.splice(idx,1); }

      setCart(cart);
      renderCart();
    }
    function onQtyChange(e){
      const input = e.target.closest('.qty-input'); if (!input) return;
      const idx = +input.dataset.idx;
      const val = Math.max(1, parseInt(input.value||'1',10));
      const cart = getCart();
      cart[idx].qty = val; setCart(cart); renderCart();
    }

    function updateSummary(){
      const cart = getCart();
      const sub = cart.reduce((s,i)=> s + i.price*(i.qty||1), 0);
      const ship = sub >= SHIP_THRESHOLD || sub===0 ? 0 : SHIP_FEE;
      const total = sub + ship;

      document.getElementById('sum-sub').textContent = fmt(sub);
      document.getElementById('sum-ship').textContent = fmt(ship);
      document.getElementById('sum-total').textContent = fmt(total);

      const remain = Math.max(0, SHIP_THRESHOLD - sub);
      document.getElementById('free-ship-tip').textContent = remain>0
        ? `Mua thêm ${fmt(remain)} để được miễn phí vận chuyển.`
        : `Bạn đã được miễn phí vận chuyển.`;
    }
  </script>
</body>
</html>
